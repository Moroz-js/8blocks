name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH (Docker Compose)
        uses: appleboy/ssh-action@v1.0.0
        env:
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
          DOMAIN: ${{ secrets.DOMAIN }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
          DEPLOY_MODE: ${{ secrets.DEPLOY_MODE }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 15m
          script_stop: true
          envs: PROJECT_NAME,DOMAIN,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,SMTP_HOST,SMTP_PORT,SMTP_USER,SMTP_PASSWORD,SMTP_FROM,ADMIN_USERNAME,ADMIN_PASSWORD,GOOGLE_ANALYTICS_ID,DEPLOY_MODE
          script: |
            set -euo pipefail

            # ==========================================
            # Configuration
            # ==========================================
            DEPLOY_MODE="${DEPLOY_MODE:-soft}"
            PROJECT_DIR="/var/www/${PROJECT_NAME}"

            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Deploying ${PROJECT_NAME}"
            echo "๐ Mode: ${DEPLOY_MODE}"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            cd "${PROJECT_DIR}"

            # ==========================================
            # 1. Pull latest code
            # ==========================================
            echo "๐ฅ Pulling latest changes"
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            # ==========================================
            # 2. Generate .env from secrets
            # ==========================================
            echo "โ๏ธ  Generating .env"
            umask 077
            cat > .env <<ENVEOF
            PROJECT_NAME=${PROJECT_NAME}
            NODE_ENV=production
            NEXT_PUBLIC_SITE_URL="https://${DOMAIN}/new"
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            POSTGRES_DB=${POSTGRES_DB}
            DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public
            SMTP_HOST=${SMTP_HOST}
            SMTP_PORT=${SMTP_PORT}
            SMTP_USER=${SMTP_USER}
            SMTP_PASSWORD=${SMTP_PASSWORD}
            SMTP_FROM=${SMTP_FROM}
            ADMIN_USERNAME=${ADMIN_USERNAME}
            ADMIN_PASSWORD=${ADMIN_PASSWORD}
            GOOGLE_ANALYTICS_ID=${GOOGLE_ANALYTICS_ID}
            UPLOAD_DIR=public/uploads
            ENVEOF
            chmod 600 .env
            echo "โ .env created"

            # ==========================================
            # 3. Cleanup (mode-dependent)
            # ==========================================
            echo "๐งน Cleaning old artifacts"
            rm -rf .next 2>/dev/null || true

            if [ "$DEPLOY_MODE" = "hard" ]; then
              echo "๐ด HARD RESET: wiping all containers, volumes, networks"

              # Stop and remove everything including volumes
              docker compose down -v --remove-orphans 2>/dev/null || true
              sleep 2

              # Force-kill any leftover containers
              for c in $(docker ps -aq --filter "name=${PROJECT_NAME}" 2>/dev/null); do
                docker rm -f "$c" 2>/dev/null || true
              done

              # Remove network, images, prune everything
              docker network rm "${PROJECT_NAME}_app-network" 2>/dev/null || true
              docker container prune -f 2>/dev/null || true
              docker network prune -f 2>/dev/null || true
              docker volume prune -f 2>/dev/null || true
              docker image rm "${PROJECT_NAME}-app:latest" --force 2>/dev/null || true

            else
              echo "๐ข SOFT RESET: keeping volumes (database data preserved)"

              # Graceful stop
              docker compose down --remove-orphans 2>/dev/null || true
              sleep 2

              # Force-kill leftover containers
              for c in $(docker ps -aq --filter "name=${PROJECT_NAME}" 2>/dev/null); do
                docker rm -f "$c" 2>/dev/null || true
              done

              # Remove network and old app image only
              docker network rm "${PROJECT_NAME}_app-network" 2>/dev/null || true
              docker container prune -f 2>/dev/null || true
              docker network prune -f 2>/dev/null || true
              docker image rm "${PROJECT_NAME}-app:latest" --force 2>/dev/null || true
            fi

            sleep 2

            # Build cache prune (non-blocking, 30s timeout max)
            echo "๐๏ธ  Pruning old build cache"
            timeout 30 docker builder prune -af --filter "until=24h" 2>/dev/null || echo "โ๏ธ  Cache prune skipped"

            # ==========================================
            # 4. Build app image
            # ==========================================
            echo "๐๏ธ  Building Docker image (no cache)"
            DOCKER_BUILDKIT=1 docker compose build --pull --no-cache app
            sleep 2

            # ==========================================
            # 5. Start PostgreSQL
            # ==========================================
            echo "๐ Starting PostgreSQL"
            docker compose up -d --force-recreate postgres

            echo "โณ Waiting for PostgreSQL..."
            for i in $(seq 1 60); do
              if docker compose exec -T postgres pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" >/dev/null 2>&1; then
                echo "โ PostgreSQL is ready"
                break
              fi
              if [ "$i" -eq 60 ]; then
                echo "โ PostgreSQL failed to start"
                docker compose logs postgres
                exit 1
              fi
              sleep 2
            done

            # ==========================================
            # 6. Run migrations BEFORE starting app
            # ==========================================
            echo "๐๏ธ  Running database migrations (via temp container)"
            docker compose run --rm -T --no-deps app sh -c "node_modules/.bin/prisma db push --skip-generate" || {
              echo "โ Database migration failed"
              exit 1
            }
            echo "โ Migrations applied"

            # ==========================================
            # 7. Start app container
            # ==========================================
            echo "๐ Starting app container"
            docker compose up -d --force-recreate app

            echo "โณ Waiting for app..."
            for i in $(seq 1 30); do
              if docker compose ps app | grep -q "Up"; then
                echo "โ App container is running"
                break
              fi
              if [ "$i" -eq 30 ]; then
                echo "โ App container failed to start"
                docker compose logs --tail=100 app
                exit 1
              fi
              sleep 2
            done

            # Additional wait for Next.js to be fully ready
            sleep 10

            if ! docker compose ps app | grep -q "Up"; then
              echo "โ App container crashed"
              docker compose logs --tail=100 app
              exit 1
            fi

            # ==========================================
            # 8. Ensure uploads directory
            # ==========================================
            echo "๐ Ensuring uploads directory"
            docker compose exec -T app mkdir -p /app/public/uploads 2>/dev/null || true
            docker compose exec -T app chmod -R 755 /app/public/uploads 2>/dev/null || true

            # ==========================================
            # 9. Database seed (mode-dependent, runs LAST)
            # ==========================================
            if [ "$DEPLOY_MODE" = "hard" ]; then
              echo "๐ฑ Running database seed (hard mode โ fresh data)"
              docker compose exec -T app npm run db:seed:prod || echo "โ๏ธ  Seed failed"
            else
              echo "โญ๏ธ  Skipping seed (soft mode โ data preserved)"
            fi

            # ==========================================
            # 10. Status & Health Check
            # ==========================================
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Container Status"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            docker compose ps

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Recent Logs"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            docker compose logs --tail=30 app

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ฅ Health Check"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            sleep 3
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/new/ || echo "000")
            if echo "$HTTP_CODE" | grep -qE "^(200|301|302|307|308)$"; then
              echo "โ App is responding (HTTP $HTTP_CODE)"
            else
              echo "โ๏ธ  App returned HTTP $HTTP_CODE"
            fi

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ Deployment completed! (mode: ${DEPLOY_MODE})"
            echo "๐ Site: https://${DOMAIN}/new"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
