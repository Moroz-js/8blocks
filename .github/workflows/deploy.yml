name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH (Docker Compose)
        uses: appleboy/ssh-action@v1.0.0
        env:
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
          DOMAIN: ${{ secrets.DOMAIN }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 15m
          script_stop: true
          envs: PROJECT_NAME,DOMAIN,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,SMTP_HOST,SMTP_PORT,SMTP_USER,SMTP_PASSWORD,SMTP_FROM,ADMIN_USERNAME,ADMIN_PASSWORD,GOOGLE_ANALYTICS_ID
          script: |
            set -euo pipefail
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Deploying ${PROJECT_NAME}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            PROJECT_DIR="/var/www/${PROJECT_NAME}"
            
            # Navigate to project directory
            echo "ğŸ“ Entering ${PROJECT_DIR}"
            cd "${PROJECT_DIR}"
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes from Git"
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # Generate .env file from GitHub Secrets
            echo "âš™ï¸  Generating .env from GitHub Secrets"
            umask 077
            cat > .env <<EOF
            # ============================================
            # Production Environment Variables
            # Auto-generated by GitHub Actions
            # ============================================
            
            # Project
            PROJECT_NAME=${PROJECT_NAME}
            
            # Runtime
            NODE_ENV=production
            
            # URLs (basePath /new is configured in next.config.ts)
            NEXT_PUBLIC_SITE_URL="https://${DOMAIN}/new"
            
            # Database (Docker internal)
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD="${POSTGRES_PASSWORD}"
            POSTGRES_DB=${POSTGRES_DB}
            DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public"
            
            # Email (SMTP via Nodemailer)
            SMTP_HOST=${SMTP_HOST}
            SMTP_PORT=${SMTP_PORT}
            SMTP_USER=${SMTP_USER}
            SMTP_PASSWORD="${SMTP_PASSWORD}"
            SMTP_FROM="${SMTP_FROM}"
            
            # Admin Authentication
            ADMIN_USERNAME=${ADMIN_USERNAME}
            ADMIN_PASSWORD="${ADMIN_PASSWORD}"
            
            # Analytics
            GOOGLE_ANALYTICS_ID=${GOOGLE_ANALYTICS_ID}
            
            # Upload Configuration
            UPLOAD_DIR=public/uploads
            EOF
            chmod 600 .env
            echo "âœ“ .env file created with secure permissions"
            
            # Start PostgreSQL
            echo "ğŸ˜ Starting PostgreSQL"
            docker compose up -d postgres
            
            # Wait for PostgreSQL to be ready
            echo "â³ Waiting for PostgreSQL to be ready..."
            for i in {1..60}; do
              if docker compose exec -T postgres pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" >/dev/null 2>&1; then
                echo "âœ“ PostgreSQL is ready"
                break
              fi
              if [ $i -eq 60 ]; then
                echo "âŒ PostgreSQL failed to start in time"
                docker compose logs postgres
                exit 1
              fi
              sleep 2
            done
            
            # Clean build artifacts (optional, helps with fresh builds)
            echo "ğŸ§¹ Cleaning old build artifacts"
            rm -rf .next || true
            
            # Prune Docker build cache to save space
            echo "ğŸ—‘ï¸  Pruning Docker build cache"
            docker builder prune -af --filter "until=24h" || true
            
            # Build application image
            echo "ğŸ—ï¸  Building application Docker image"
            DOCKER_BUILDKIT=1 docker compose build --pull --no-cache app
            
            # Recreate and start app container
            echo "ğŸ”„ Recreating and starting app container"
            docker compose up -d --force-recreate app
            
            # Wait for app to initialize
            echo "â³ Waiting for app to initialize..."
            sleep 5
            
            # Ensure uploads directory exists with correct permissions
            echo "ğŸ“‚ Ensuring uploads directory exists"
            docker compose exec -T app mkdir -p /app/public/uploads || true
            docker compose exec -T app chmod -R 755 /app/public/uploads || true
            
            # Run Prisma migrations
            echo "ğŸ—„ï¸  Running Prisma migrations"
            docker compose exec -T app npx prisma generate || echo "âš ï¸  Prisma generate failed (may already be generated)"
            docker compose exec -T app npx prisma db push || {
              echo "âŒ Database migration failed"
              docker compose logs --tail=50 app
              exit 1
            }
            echo "âœ“ Migrations applied"
            
            # Run database seed (optional)
            echo "ğŸŒ± Running database seed (optional)"
            if docker compose exec -T app npm run | grep -q "db:seed"; then
              docker compose exec -T app npm run db:seed || echo "âš ï¸  Seed failed or skipped"
            else
              echo "âš ï¸  No db:seed script found, skipping"
            fi
            
            # Show container status
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Container Status"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker compose ps
            
            # Show recent logs
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“œ Recent Application Logs"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker compose logs --tail=60 app
            
            # Health check
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ¥ Health Check"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Wait a bit for app to be fully ready
            sleep 3
            
            # Check if app responds on /new path
            if curl -f -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/new | grep -q "200\|301\|302\|307"; then
              echo "âœ… App is responding on http://127.0.0.1:3000/new"
            else
              echo "âš ï¸  App may not be responding yet (this is normal during first start)"
            fi
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Site: https://${DOMAIN}/new"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
